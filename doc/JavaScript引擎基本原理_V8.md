# JavaScript 引擎基本原理_V8

V8 是 Google 开发的开源的 javaScript 引擎，主要功能是执行 JavaScript 代码。

高级编程语言有两种执行方式：
1. **编译执行**，解析器将源代码转换为中间代码，然后解析器将中间代码转换成机器代码放入内存或二进制文件。机器代码加载入内存后可以直接有 CPU 执行
2. **解释执行**，解析器将源代码转换为中间代码，然后解释器解释执行中间代码，直接输出执行结果

V8 并没有采用单一的技术执行 JavaScript 代码，而是混合编译执行和解释执行这两种方式，即**即时编译**

## 编译流水线

![](https://cdn.jsdelivr.net/gh/wangchiech/image_store/img/202403111354614.png)

1. 初始化 V8 执行 JavaScript 代码所需的基础环境(运行时环境)
    - 堆空间(Heap)、栈空间(Call Stack)、全局执行上下文、全局作用域、内置的内建函数、宿主环境提供的扩展函数和对象、消息循环系统、一个运行时主线程
2. 初始化 V8
3. V8 解析源代码生成 AST 和作用域
    - 源代码于 V8 而言就是一段字符串，经过**词法分析(tokenize)**、**语法分析(parse)**生成作用域和结构化的 AST (抽象语法树)
4. 根据 AST 和作用域生成字节码
    - Ignition 解释器根据 AST 和作用域生成字节码
    - 字节码是介于源代码与机器码之间的代码，可以由解释器直接解释执行，或由编译器编译成机器码(引入字节码的意义在于解决 AST 直接转换为机器码占用内存过大的问题)
5. 解释执行字节码
    - Ignition 解释器解释执行字节码
6. 监听热点代码
    - 在解释执行字节码的过程中，会有一个**监控器**监控整个过程来收集信息，如果某段代码被重复执行的次数超过了一定的阈值，就是将其标记为**热点代码(HotSpot)**
7. 优化热点代码为二进制代码
    - **热点代码**会被 V8 编译器(TurboFan)编译成二机制代码，并对二进制代码进行一定的优化，下次再执行到这段代码是就会直接执行优化后的二进制代码
8. 反优化生成的二进制代码
    - 因为 JavaScript 在运行时可以任意修改对象结构，若结构被修改，优化后的二进制代码生效，此时编译器会执行**反优化**操作，下次再执行时就会会退到解释器解释执行字节码

## 机制
### 即时编译(JIT，Just In Time)

JIT 采用双轮驱动的设计，混合编译执行与解释执行两种手段来提升 JavaScript 代码的执行效率

JIT 是一种权衡策略，**解释执行**启动速度快，但执行速度慢；**编译执行**启动速度慢，但执行速度快，两者各有优缺点

### 惰性编译

目的是为了加速代码的启动速度

### 内联缓存

### 隐藏类(Hide Class)

是将 JavaScript 中动态类型转换为静态类型的一种技术，可以消除动态类型语言执行速度过慢的问题。


## 参考

[图解 Google V8 -极客时间](https://time.geekbang.org/column/intro/100048001?tab=catalog)

[认识 V8 引擎](https://zhuanlan.zhihu.com/p/27628685)